<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç¾è¨ºæ‰€åˆ†æ½¤è¨ˆç®—ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50">
    <div class="min-h-screen py-8 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- æ¨™é¡Œ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">ğŸ’¼ é†«ç¾è¨ºæ‰€åˆ†æ½¤è¨ˆç®—ç³»çµ±</h1>
                <p class="text-gray-600">éˆæ´»é…ç½®åˆ†æ½¤æ¯”ä¾‹ã€è¨ˆç®—æ¥­ç¸¾çé‡‘ã€å¯¦æ™‚æŸ¥çœ‹åˆ†é…çµæœ</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- å·¦å´ï¼šåŸºæœ¬è¨­ç½® -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg p-6 sticky top-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“Š åŸºæœ¬è¨­ç½®</h2>

                        <!-- æœˆåº¦ç²åˆ© -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                æœˆåº¦ç¸½ç²åˆ©
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-500 font-semibold">NT$</span>
                                <input type="number" id="totalProfit" value="500000"
                                    class="w-full pl-10 pr-4 py-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    min="0">
                            </div>
                        </div>

                        <!-- é ç•™é‡‘é¡ -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                é ç•™ç‡Ÿé‹é‡‘ (%)
                            </label>
                            <input type="number" id="operatingReserve" value="10"
                                class="w-full px-4 py-2 border-2 border-green-300 rounded-lg focus:outline-none focus:border-green-500"
                                min="0" max="100">
                            <p class="text-xs text-gray-500 mt-1">
                                é ç•™é‡‘é¡: <span class="font-semibold" id="reserveAmount">NT$ 0</span>
                            </p>
                        </div>

                        <!-- å¯åˆ†é…é‡‘é¡ -->
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 mb-6">
                            <p class="text-xs text-gray-600 mb-1">å¯åˆ†é…é‡‘é¡</p>
                            <p class="text-3xl font-bold text-blue-600" id="availableAmount">NT$ 0</p>
                        </div>

                        <!-- åˆ†æ½¤é…ç½®èªªæ˜ -->
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <h3 class="font-semibold text-gray-900 mb-2">ğŸ”§ åˆ†æ½¤é…ç½®èªªæ˜</h3>
                            <ul class="text-xs text-gray-700 space-y-1">
                                <li>âœ“ æ‰€æœ‰å“¡å·¥åˆ†æ½¤æ¯”ä¾‹åŠ ç¸½æ‡‰ç‚º 100%</li>
                                <li>âœ“ æ¥­ç¸¾çé‡‘ç¨ç«‹è¨ˆç®—ï¼Œä¸å½±éŸ¿åˆ†æ½¤</li>
                                <li>âœ“ å¯¦æ™‚æ›´æ–°è¨ˆç®—çµæœ</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é–“ï¼šæˆå“¡é…ç½® -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ‘¥ æˆå“¡åˆ†æ½¤é…ç½®</h2>

                        <div id="memberContainer" class="space-y-4">
                            <!-- å‹•æ…‹ç”Ÿæˆæˆå“¡ -->
                        </div>

                        <!-- æ–°å¢æˆå“¡ -->
                        <button onclick="addMember()"
                            class="w-full mt-6 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-2 rounded-lg transition-all">
                            + æ–°å¢æˆå“¡
                        </button>

                        <!-- åˆ†æ½¤åˆè¨ˆæª¢æŸ¥ -->
                        <div class="mt-6 p-4 rounded-lg" id="totalPercentageBox">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-gray-700">åˆ†æ½¤åˆè¨ˆ</span>
                                <span class="text-2xl font-bold" id="totalPercentage">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- æ¥­ç¸¾çé‡‘è¨­ç½® -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ† æ¥­ç¸¾çé‡‘è¨­ç½®</h2>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    æ¥­ç¸¾çé‡‘ç¸½é¡ (%)
                                </label>
                                <input type="number" id="bonusPercentage" value="5"
                                    class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                                    min="0" max="100">
                                <p class="text-xs text-gray-500 mt-1">
                                    çé‡‘æ± : <span class="font-semibold" id="bonusPool">NT$ 0</span>
                                </p>
                            </div>

                            <div id="bonusContainer" class="space-y-3">
                                <!-- å‹•æ…‹ç”Ÿæˆæ¥­ç¸¾çé‡‘ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šçµæœå±•ç¤º -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ’° åˆ†é…çµæœ</h2>

                        <div id="resultContainer" class="space-y-3">
                            <!-- å‹•æ…‹ç”Ÿæˆçµæœ -->
                        </div>

                        <!-- çµ±è¨ˆæ‘˜è¦ -->
                        <div
                            class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-4 mt-6 border border-gray-200">
                            <h3 class="font-semibold text-gray-900 mb-3">ğŸ“ˆ çµ±è¨ˆæ‘˜è¦</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ç¸½äººæ•¸</span>
                                    <span class="font-semibold" id="totalMembers">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">åˆ†é…ç¸½é¡</span>
                                    <span class="font-semibold text-green-600" id="totalDistributed">NT$ 0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">é ç•™é‡‘é¡</span>
                                    <span class="font-semibold text-blue-600" id="summaryReserve">NT$ 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- å°å‡ºåŠŸèƒ½ -->
                        <div class="mt-6 space-y-2">
                            <button onclick="exportAsCSV()"
                                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition-all">
                                ğŸ“¥ åŒ¯å‡ºç‚º CSV
                            </button>
                            <button onclick="printPage()"
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition-all">
                                ğŸ–¨ï¸ åˆ—å°
                            </button>
                        </div>
                    </div>

                    <!-- åœ–è¡¨ -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ“Š åˆ†æ½¤åˆ†å¸ƒåœ–</h3>
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é»˜èªæˆå“¡æ•¸æ“š
        const defaultMembers = [
            { id: 1, name: 'è€é—†', role: 'è€é—†', percentage: 30 },
            { id: 2, name: 'é†«ç”ŸA', role: 'é†«ç”Ÿ', percentage: 35 },
            { id: 3, name: 'è­·å£«B', role: 'è­·å£«', percentage: 15 },
            { id: 4, name: 'æ¥­å‹™C', role: 'æ¥­å‹™', percentage: 15 },
            { id: 5, name: 'è¡Œæ”¿D', role: 'è¡Œæ”¿', percentage: 5 }
        ];

        let members = JSON.parse(JSON.stringify(defaultMembers));
        let nextMemberId = 6;
        let chart = null;

        const roleColors = {
            'è€é—†': '#3b82f6',
            'é†«ç”Ÿ': '#ef4444',
            'è­·å£«': '#f59e0b',
            'æ¥­å‹™': '#10b981',
            'è¡Œæ”¿': '#8b5cf6'
        };

        const roleEmojis = {
            'è€é—†': 'ğŸ‘”',
            'é†«ç”Ÿ': 'ğŸ‘¨â€âš•ï¸',
            'è­·å£«': 'ğŸ‘©â€âš•ï¸',
            'æ¥­å‹™': 'ğŸ’¼',
            'è¡Œæ”¿': 'ğŸ“‹'
        };

        // æ ¼å¼åŒ–è²¨å¹£
        function formatCurrency(num) {
            return 'NT$ ' + Math.round(num).toLocaleString();
        }

        // åˆå§‹åŒ–
        function init() {
            renderMembers();
            renderBonusConfig();
            calculate();
        }

        // æ¸²æŸ“æˆå“¡åˆ—è¡¨
        function renderMembers() {
            const container = document.getElementById('memberContainer');
            container.innerHTML = members.map(member => `
                <div class="bg-gray-50 p-4 rounded-lg border-l-4" style="border-color: ${roleColors[member.role]}">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${roleEmojis[member.role]}</span>
                            <input type="text" value="${member.name}" 
                                onchange="updateMember(${member.id}, 'name', this.value)"
                                class="px-3 py-1 border rounded font-semibold text-gray-900 focus:outline-none focus:border-blue-500">
                        </div>
                        <button onclick="removeMember(${member.id})" class="text-red-500 hover:text-red-700 font-bold text-xl transition-all">
                            âœ•
                        </button>
                    </div>
                    
                    <div class="mb-2">
                        <label class="text-xs text-gray-600 block mb-1">è·ä½</label>
                        <select onchange="updateMember(${member.id}, 'role', this.value)"
                            class="w-full px-2 py-1 border rounded text-sm focus:outline-none focus:border-blue-500">
                            ${Object.keys(roleEmojis).map(role =>
                `<option value="${role}" ${member.role === role ? 'selected' : ''}>${role}</option>`
            ).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="text-xs text-gray-600 block mb-1">åˆ†æ½¤æ¯”ä¾‹</label>
                        <div class="flex items-center gap-2">
                            <input type="range" min="0" max="100" value="${member.percentage}"
                                onchange="updateMember(${member.id}, 'percentage', this.value)"
                                class="flex-1 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                            <input type="number" value="${member.percentage}" 
                                onchange="updateMember(${member.id}, 'percentage', this.value)"
                                class="w-16 px-2 py-1 border rounded text-center font-semibold focus:outline-none focus:border-blue-500"
                                min="0" max="100">
                            <span class="text-sm font-semibold text-gray-600">%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“æ¥­ç¸¾çé‡‘é…ç½®
        function renderBonusConfig() {
            const bonusPercentage = parseFloat(document.getElementById('bonusPercentage').value);
            const totalProfit = parseFloat(document.getElementById('totalProfit').value);
            const operatingReserve = parseFloat(document.getElementById('operatingReserve').value);
            const availableAmount = totalProfit * (1 - operatingReserve / 100);
            const bonusPool = availableAmount * (bonusPercentage / 100);

            const container = document.getElementById('bonusContainer');

            // åªç‚ºæœ‰è¨­ç½®çš„æˆå“¡é¡¯ç¤ºæ¥­ç¸¾çé‡‘
            const hasBonusMembers = members.filter(m => m.bonusPercentage);

            if (hasBonusMembers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500 text-sm">
                        å°šæœªç‚ºä»»ä½•æˆå“¡è¨­ç½®æ¥­ç¸¾çé‡‘
                    </div>
                `;
                return;
            }

            container.innerHTML = hasBonusMembers.map(member => `
                <div class="bg-purple-50 p-3 rounded border border-purple-200">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-900">${member.name}</span>
                        <button onclick="updateMember(${member.id}, 'bonusPercentage', 0)" 
                            class="text-red-500 hover:text-red-700 text-sm">ç§»é™¤</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="range" min="0" max="100" value="${member.bonusPercentage || 0}"
                            onchange="updateMember(${member.id}, 'bonusPercentage', this.value)"
                            class="flex-1 h-2 bg-purple-300 rounded-lg appearance-none cursor-pointer">
                        <input type="number" value="${member.bonusPercentage || 0}" 
                            onchange="updateMember(${member.id}, 'bonusPercentage', this.value)"
                            class="w-12 px-2 py-1 border rounded text-center text-sm font-semibold focus:outline-none focus:border-purple-500"
                            min="0" max="100">
                        <span class="text-xs font-semibold text-gray-600">%</span>
                    </div>
                </div>
            `).join('');

            // æ·»åŠ è¨­ç½®æ¥­ç¸¾çé‡‘çš„æŒ‰éˆ•
            const unsetBonusMembers = members.filter(m => !m.bonusPercentage);
            if (unsetBonusMembers.length > 0) {
                container.innerHTML += `
                    <div class="mt-3 pt-3 border-t">
                        <p class="text-xs text-gray-600 mb-2">æ–°å¢æ¥­ç¸¾çé‡‘æˆå“¡:</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${unsetBonusMembers.map(member => `
                                <button onclick="updateMember(${member.id}, 'bonusPercentage', 10)"
                                    class="text-xs bg-purple-200 hover:bg-purple-300 text-purple-900 py-1 px-2 rounded transition-all">
                                    + ${member.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // æ›´æ–°æˆå“¡
        function updateMember(id, field, value) {
            const member = members.find(m => m.id === id);
            if (member) {
                if (field === 'percentage' || field === 'bonusPercentage') {
                    member[field] = Math.max(0, Math.min(100, parseFloat(value) || 0));
                } else {
                    member[field] = value;
                }
                renderMembers();
                renderBonusConfig();
                calculate();
            }
        }

        // æ–°å¢æˆå“¡
        function addMember() {
            members.push({
                id: nextMemberId++,
                name: `æ–°æˆå“¡${nextMemberId - 5}`,
                role: 'è¡Œæ”¿',
                percentage: 0,
                bonusPercentage: 0
            });
            renderMembers();
            calculate();
        }

        // åˆªé™¤æˆå“¡
        function removeMember(id) {
            if (members.length === 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æˆå“¡');
                return;
            }
            members = members.filter(m => m.id !== id);
            renderMembers();
            renderBonusConfig();
            calculate();
        }

        // è¨ˆç®—åŠæ›´æ–°
        function calculate() {
            const totalProfit = parseFloat(document.getElementById('totalProfit').value) || 0;
            const operatingReserve = parseFloat(document.getElementById('operatingReserve').value) || 0;
            const bonusPercentage = parseFloat(document.getElementById('bonusPercentage').value) || 0;

            // è¨ˆç®—å¯åˆ†é…é‡‘é¡
            const reserveAmount = totalProfit * (operatingReserve / 100);
            const availableAmount = totalProfit - reserveAmount;
            const bonusPool = availableAmount * (bonusPercentage / 100);
            const distributionAmount = availableAmount - bonusPool;

            // æ›´æ–°UI
            document.getElementById('reserveAmount').textContent = formatCurrency(reserveAmount);
            document.getElementById('availableAmount').textContent = formatCurrency(availableAmount);
            document.getElementById('bonusPool').textContent = formatCurrency(bonusPool);

            // è¨ˆç®—æˆå“¡åˆ†é…
            const totalPercentage = members.reduce((sum, m) => sum + m.percentage, 0);
            document.getElementById('totalPercentage').textContent = `${totalPercentage}%`;

            // åˆ†æ½¤åˆè¨ˆé¡è‰²æç¤º
            const totalPercentageBox = document.getElementById('totalPercentageBox');
            if (totalPercentage === 100) {
                totalPercentageBox.className = 'mt-6 p-4 rounded-lg bg-green-50 border-2 border-green-300';
            } else if (totalPercentage > 100) {
                totalPercentageBox.className = 'mt-6 p-4 rounded-lg bg-red-50 border-2 border-red-300';
            } else {
                totalPercentageBox.className = 'mt-6 p-4 rounded-lg bg-yellow-50 border-2 border-yellow-300';
            }

            // è¨ˆç®—çµæœ
            const results = members.map(member => {
                const profitShare = (distributionAmount * member.percentage / 100) || 0;
                const totalBonus = members.filter(m => m.bonusPercentage).reduce((sum, m) => sum + m.bonusPercentage, 0);
                const bonusAmount = totalBonus > 0 ? (bonusPool * (member.bonusPercentage || 0) / totalBonus) : 0;
                const total = profitShare + bonusAmount;

                return {
                    id: member.id,
                    name: member.name,
                    role: member.role,
                    percentage: member.percentage,
                    profitShare,
                    bonusPercentage: member.bonusPercentage || 0,
                    bonusAmount,
                    total
                };
            });

            // æ¸²æŸ“çµæœ
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.innerHTML = results.map(result => `
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-lg border-l-4" style="border-color: ${roleColors[result.role]}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${roleEmojis[result.role]}</span>
                            <span class="font-semibold text-gray-900">${result.name}</span>
                        </div>
                        <span class="text-xs bg-gray-300 text-gray-800 px-2 py-1 rounded">${result.role}</span>
                    </div>
                    
                    <div class="space-y-1 text-sm">
                        ${result.percentage > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600">åˆ†æ½¤ (${result.percentage}%)</span>
                                <span class="font-semibold text-blue-600">${formatCurrency(result.profitShare)}</span>
                            </div>
                        ` : ''}
                        ${result.bonusAmount > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600">çé‡‘ (${result.bonusPercentage}%)</span>
                                <span class="font-semibold text-purple-600">${formatCurrency(result.bonusAmount)}</span>
                            </div>
                        ` : ''}
                        <div class="flex justify-between pt-2 border-t border-gray-300">
                            <span class="font-bold text-gray-900">åˆè¨ˆ</span>
                            <span class="font-bold text-lg text-green-600">${formatCurrency(result.total)}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // çµ±è¨ˆæ‘˜è¦
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('totalDistributed').textContent = formatCurrency(
                results.reduce((sum, r) => sum + r.total, 0)
            );
            document.getElementById('summaryReserve').textContent = formatCurrency(reserveAmount);

            // æ›´æ–°åœ–è¡¨
            updateChart(results);
        }

        // æ›´æ–°åœ–è¡¨
        function updateChart(results) {
            const ctx = document.getElementById('distributionChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: results.map(r => r.name),
                    datasets: [{
                        data: results.map(r => r.total),
                        backgroundColor: results.map(r => roleColors[r.role]),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 12 },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `NT$ ${Math.round(value).toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // åŒ¯å‡ºCSV
        function exportAsCSV() {
            const totalProfit = parseFloat(document.getElementById('totalProfit').value);
            const operatingReserve = parseFloat(document.getElementById('operatingReserve').value);
            const bonusPercentage = parseFloat(document.getElementById('bonusPercentage').value);

            const reserveAmount = totalProfit * (operatingReserve / 100);
            const availableAmount = totalProfit - reserveAmount;
            const bonusPool = availableAmount * (bonusPercentage / 100);
            const distributionAmount = availableAmount - bonusPool;

            const results = members.map(member => {
                const profitShare = (distributionAmount * member.percentage / 100) || 0;
                const totalBonus = members.filter(m => m.bonusPercentage).reduce((sum, m) => sum + m.bonusPercentage, 0);
                const bonusAmount = totalBonus > 0 ? (bonusPool * (member.bonusPercentage || 0) / totalBonus) : 0;
                const total = profitShare + bonusAmount;
                return [member.name, member.role, member.percentage, profitShare, member.bonusPercentage, bonusAmount, total];
            });

            const headers = ['å§“å', 'è·ä½', 'åˆ†æ½¤æ¯”ä¾‹(%)', 'åˆ†æ½¤é‡‘é¡', 'æ¥­ç¸¾çé‡‘æ¯”ä¾‹(%)', 'æ¥­ç¸¾çé‡‘', 'åˆè¨ˆ'];
            const csv = [
                ['é†«ç¾è¨ºæ‰€åˆ†æ½¤è¨ˆç®—ç³»çµ±'],
                [`æœˆåº¦ç¸½ç²åˆ©,NT$ ${totalProfit.toLocaleString()}`],
                [`é ç•™ç‡Ÿé‹é‡‘,NT$ ${reserveAmount.toLocaleString()}`],
                [`å¯åˆ†é…é‡‘é¡,NT$ ${availableAmount.toLocaleString()}`],
                [],
                headers,
                ...results.map(r => [
                    r[0], r[1], r[2], r[3].toLocaleString('zh-TW', { style: 'currency', currency: 'TWD' }),
                    r[4], r[5].toLocaleString('zh-TW', { style: 'currency', currency: 'TWD' }),
                    r[6].toLocaleString('zh-TW', { style: 'currency', currency: 'TWD' })
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `é†«ç¾è¨ºæ‰€åˆ†æ½¤è¨ˆç®—_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // åˆ—å°
        function printPage() {
            window.print();
        }

        // ç›£è½è¼¸å…¥è®ŠåŒ–
        document.getElementById('totalProfit').addEventListener('change', calculate);
        document.getElementById('operatingReserve').addEventListener('change', calculate);
        document.getElementById('bonusPercentage').addEventListener('change', () => {
            renderBonusConfig();
            calculate();
        });

        // åˆå§‹åŒ–
        init();
    </script>

    <style>
        @media print {
            .no-print {
                display: none;
            }

            body {
                background: white;
            }
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</body>

</html>